# 字幕遗漏检测与优化计划

## 背景
转录模型在处理快速语段或多噪音区域时，可能会产生长时间的间隙（Gap）或低字数密度段（Low Density），导致字幕不连贯或漏词。

## 漏词检测算法 (V1)
通过对 `0_zgry0AGqU` 的分析，我们确定了以下检测逻辑：

1. **大跨度间隙 (Gap Detection)**: 
   - 定义：`Segment[i].start - Segment[i-1].end > 3.0s`
   - 意义：模型在该时间段内完全没有识别出任何合法的语音。

2. **低语速密度 (Low Density Detection)**:
   - 算法：`Characters / Duration < 1.2 CPS` (平均 3.5 CPS 为正常)
   - 意义：模型虽然输出了文字，但由于音频模糊，可能只抓住了几个关键词，导致大量文字遗漏。

---

## 优化方案

### 第一阶段：标记与警告 (UI/LLM层面)
- **预处理**：在调用 LLM 校正前，向 `text_with_timestamps` 注入标记，例如：
  `[Gap: 4.6s, Possibly missing text here]`
- **LLM 行为**：提示词要求 LLM 尝试根据上下文衔接这些断层，或者在输出中保持段落物理分割以警示用户。

### 第二阶段：针对性重转录 (模型层面)
- **双模型联动**：当检测到 Gap > 5s 时，自动提取该音频片段。
- **差异化重试**：
    - 使用 **Whisper Small** 替代 Base 模型进行反复扫描。
    - 或者调整 `no_speech_threshold` 和 `beam_size` 参数重新识别该片段。

#### 模型选择建议 (补漏背景)

| 模型名称 | 参数量 | 相对速度 | 准确度 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **tiny** | 39 M | ~32x | 较低 | 极致速度，不推荐补漏 |
| **base** | 74 M | ~16x | 基础 | 快速识别明显的**乱码幻觉** |
| **small** | 244 M | ~6x | **中等** | **间隙补漏 (Gap Filling)** 推荐 |
| **medium** | 769 M | ~2x | 较高 | 性能消耗较大 |
| **large-v3**| 1550 M | 1x | 最高 | 主转录模型 |

**为什么补漏建议使用 `small` 而非 `base`？**
1. **精度跨越**：`small` 模型的参数量是 `base` 的 3 倍以上，识别中短模糊音频片段的能力显著增强。
2. **性能平衡**：由于仅对几秒钟的间隙进行局部补录，`small` 模型在 CPU/M芯片上的响应速度依然在秒级，是精度与速度的最佳平衡点。

### 第三阶段：语速自适应 (估算层面)
- 根据视频前 2 分钟统计该说话人的平均 CPS。
- 为不同说话人动态调整检测阈值。

---

## 验证与测试
- 已创建测试工具：[test_gap_detection.py](file:///Users/bu/Projects/Lijing/AppDev/tldw/tldw_antig/backend/tests/test_gap_detection.py)
- 测试数据：`0_zgry0AGqU` 成功检测到 4.6s 及 23s 的异常间隙。
