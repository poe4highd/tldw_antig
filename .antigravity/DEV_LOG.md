# 2026-01-18 开发日志 (Part 19)

## 任务：实现开发与生产环境彻底分离 (Environment Isolation)

### 1. 需求与现象
- **问题**：在本地开发服务器测试时，Google Auth 登录后会自动跳转到生产域名 `read-tube.com`。
- **原因**：认证回调地址（redirectTo）使用了配置在 `.env.local` 中的硬编码 `NEXT_PUBLIC_SITE_URL`。

### 2. 解决方案
- **动态 URL 获取**：创建 `utils/api.ts`，利用 `window.location.origin` 动态获取当前站点地址。
- **API 统一管理**：重写了 Dashboard 和 Dev Logs 页面的 API 请求基地址判断逻辑，统一由 `getApiBase()` 接管。
- **配置修复**：更新 `.env.local` 将默认站点地址指向本地。

### 3. 回顾与经验
- **环境隔离**：在涉及 OAuth 认证的项目中，回调地址决不能硬编码。使用 `window.location.origin` 可以完美适配本地、预览分支（Vercel）及生产环境，无需频繁手动更改环境变量。
- **配置冗余**：代码中多处出现的 `hostname === "read-tube.com"` 判断被成功收敛，提升了代码的可维护性。

---

# 2026-01-18 开发日志 (Part 18)

## 任务：修复同步按钮与移动端布局遮挡 (Interaction Bugfix)

### 1. 同步按钮失效
- **现象**：手动滚动字幕后，期望在右下角出现的“同步播放进度”按钮未出现。
- **原因**：此前代码虽有 `isAutoScrollPaused` 状态，但缺少 `onWheel` 和 `onTouchMove` 事件绑定来触发状态变更。
- **解决**：在字幕容器上添加滚动监听，并增加 `isProgrammaticScroll.current` 判定，防止程序自动滚动触发误停。

### 2. 字幕“钻到”视频下面
- **现象**：移动端向下滚动时，视频 Header 吸顶，但字幕在向上移动时会从 Header 的圆角或下方缝隙处透出来。
- **原因**：Header 带有圆角、背景半透明且 `top` 值未完全贴合导航栏。
- **解决**：
    - 精准设置 `sticky top-[72px]`。
    - 移除吸顶时的 `rounded-b-3xl`。
    - 设为不透明背景 `bg-slate-950`。

---

# 2026-01-18 开发日志 (Part 11)

## 任务：修复字幕同步问题

### 1. 需求背景
- **问题描述**：视频播放时，字幕高亮功能失效，无法跟随视频进度自动跳转。
- **原因分析**：YouTube IFrame API 在启用 `enablejsapi=1` 时，若不指定 `origin` 参数，浏览器会阻止跨域 `postMessage` 通信，导致 `currentTime` 无法回传。

### 2. 方案实施
- **Origin 注入**：
    - 在 `frontend/app/result/[id]/page.tsx` 中，使用 `useEffect` 获取并在 Client Side 注入 `window.location.origin`。
    - 修复了 iframe `src` 构建逻辑，追加 `&origin=${origin}` 参数。


### 3. 回顾
- **第三方集成**：依赖 `postMessage` 的第三方嵌入组件（如 YouTube, Vimeo）对 Origin 策略非常敏感，必须严格遵循官方安全参数要求。

---

# 2026-01-18 开发日志 (Part 17)

## 任务：优化字幕区域自动滚动 (Scroll Logic Refinement)

### 1. 问题
- **现象**：虽然布局已固定，但使用 `scrollIntoView` 会触发浏览器的“视口居中”行为，导致整个页面（包括 Main Window）发生滚动，使用户感觉“字幕跑到了视频后面”或页面发生抖动。
- **需求**：仅字幕容器内部滚动，页面主体不动。

### 2. 解决方案
- **自定义滚动计算**：
    - 引入 `subtitleContainerRef` 获取字幕容器 DOM。
    - 计算公式：`targetScroll = container.scrollTop + elementOffset - containerHeight/2 + elementHeight/2`。
    - 使用 `container.scrollTo({ top: target, behavior: 'smooth' })` 替代全局 API。
    - **优化**：将防抖阈值从 `50px` 降低至 `10px`，确保字幕始终保持在视觉绝对中心，消除“将至未至”的漂移感。
- **强制回正**：重构了 `resumeAutoScroll` 函数，在点击“同步播放进度”按钮时，传递 `force=true` 参数，无视防抖阈值，强制字幕立即滚动到当前播放位置。
- **效果**：无论字幕如何变化，左侧 Video Header 纹丝不动，仅下方字幕区域平滑流转。

---

# 2026-01-18 开发日志 (Part 12)

## 任务：重构视频播放器 (React-YouTube)

### 1. 需求背景
- **问题描述**：尽管修复了 Origin，原生的 `iframe` `postMessage` 通信在组件重渲染或网络延迟时依然不稳定，导致字幕同步时有时无。
- **历史调查**：早期版本之所以稳定，是因为使用了本地文件播放 (`<video>`)，原生支持 DOM 事件。切换到 Iframe 后丢失了这一优势。

### 2. 方案实施
- **架构重构**：
    - 废弃手动维护的 Iframe 通信逻辑。
    - 引入 `react-youtube` 库作为中间件。
    - 利用 `onReady` 获取播放器实例，结合定时轮询 `getCurrentTime()` 确保 100% 的同步可靠性。

### 3. 回顾
- **技术选型**：在处理像 YouTube 播放器这样复杂的第三方黑盒组件时，优先使用成熟的封装库（如 `react-youtube`）比重复造轮子（手动处理 postMessage协议）更高效且稳健。

---

# 2026-01-18 开发日志 (Part 14)

## 任务：修复初始化字幕同步失效 (Fix Initial Sync)

### 1. 问题定位
- **现象**：页面强制刷新后，Subtitle Sync 失效；切换到 Local Audio 再切回 YouTube 后恢复正常。
- **根因**：使用了 `useState` 存储 YouTube Player 实例。`useEffect` 的轮询闭包在组件初次渲染时捕获了旧的 state (null)，即使后续 state 更新，定时器内的闭包变量未更新（或者依赖项未触发预期的重置）。

### 2. 解决方案
- **Refactor**：改用 `useRef` 存储 Player 实例，利用 mutable ref 特性穿透反闭包。
- **状态分离**：分离 `isPlayerReady` 状态用于触发 UI 渲染和 Effect 启动，确保逻辑链条清晰：`onReady` -> `ref.current = player` -> `setReady(true)` -> `useEffect` start polling.

---

# 2026-01-18 开发日志 (Part 15)

## 任务：重构左侧栏布局 (Fixed Header + Scrollable Body)

### 1. 需求背景
- **用户痛点**：原有布局中，字幕跟随整个页面滚动。当字幕很长时，用户为了看字幕必须向下滚动，导致视频播放器滚出视野，无法同时观看视频和阅读字幕。
- **目标**：实现“Dashboard 风格”布局——视频和操作区固定在顶部，仅字幕区域独立滚动。

### 2. 方案实施
- **Flex Column 布局**：将左侧容器 (`lg:col-span-8`) 改为 Flex 布局，并设置 `sticky top-24` 和固定高度 `calc(100vh - 8rem)`。
- **区域划分**：
    - **Header (Flex-none)**: 包含 Video Player, Toolbar, Metadata。这些元素占据固定空间。
    - **Body (Flex-1)**: 字幕区域设置为 `flex-1 overflow-y-auto`，自动填满剩余高度并提供滚动。
- **细节处理**：
    - 移除 Video Player 原有的 `sticky` 属性（由父容器接管）。
    - 增加 `min-h-0` 防止 Flex 子元素溢出问题。
    - 增加 `pr-2` 右侧内边距，防止滚动条遮挡文字。

### 3. 回顾
- **布局现代化**：这种“应用级”布局比传统的“文档流”布局更适合富交互页面。

---

# 2026-01-18 开发日志 (Part 16)

## 任务：品牌升级 - 仪表盘更名为“见地”

### 1. 需求背景
- **问题**：“仪表盘 (Dashboard)”一词过于工业化/SaaS 化，不符合产品“深度阅读与知识沉淀”的调性。
- **决定**：采纳“见地 (Insights)”作为新的功能模块名称。

### 2. 执行内容
- **全站替换**：扫描并替换了所有前端页面（Dashboard, Admin, Result, Tasks）中用户可见的“仪表盘”文案。
- **保留路由**：保留了 `/dashboard` 的 URL 路由结构，仅修改显示文本，最小化技术风险。

---

# 2026-01-18 开发日志 (Part 15)

## 任务：优化字幕阅读体验 (UX Enhancement)

### 1. 需求背景
- **问题描述**：用户反馈自动滚动体验不佳（字幕容易跑出视野），且无法方便地查看历史字幕（会被自动滚动强制拉回）。
- **目标**：实现“视频不动字幕动”，且支持“主动阅读模式”（暂停自动滚动）。

### 2. 方案实施
- **布局优化**：使用 CSS `sticky` 对视频容器进行吸顶处理，确保长字幕阅读时视频不消失。
- **智能滚动**：
    - 使用 `scrollIntoView({ block: 'center' })` 确保高亮行始终位于视野中心。
    - 增加防抖阈值（100px），避免微小变动导致的画面抖动。
- **交互状态机**：
    - 引入 `isAutoScrollPaused` 状态。
    - 监听 `wheel` 和 `touchmove` 事件：一旦检测到用户主动操作，立即设置 `paused = true`。
    - UI 增加悬浮按钮“同步播放进度”，点击后重置状态并立即回正。

### 3. 回顾
- **体验细节**：区分“机器滚动”和“人为滚动”是体验优化的关键。通过监听原生事件而非 scroll 事件（scroll 事件会被代码触发）成功实现了这一区分。

---

# 2026-01-18 开发日志 (Part 10)

## 任务：诊断并修复 Cloudflare 隧道连接问题

### 1. 需求背景
- **问题描述**：公网访问 `api.read-tube.com` 返回 530 错误，并引发前端 CORS 错误。经排查，本地 `cloudflared` 隧道凭证丢失，即使 Login 也无法恢复原 UUID。

### 2. 方案实施
- **隧道重建**：
    - 删除失效的旧隧道。
    - 使用 `cloudflared tunnel create` 创建新隧道 `mac-read-tube`。
    - 生成本地 `config.yml` 配置文件。
    - 使用 `cloudflared tunnel route dns -f` 强制更新 CNAME 记录。
- **脚本优化**：
    - 在 `dev.sh` 中集成了 `pgrep` 检查，若检测不到 `cloudflared` 进程会输出黄色警告，提醒开发者启动隧道。

### 3. 回顾
- **坑点记录**：Cloudflare 的 `tunnel login` 仅生成用户证书，并不恢复特定隧道的 `credentials.json`。如果后者丢失，最快的恢复路径往往是删除并重建隧道，而非尝试找回旧凭证。
- **环境一致性**：将隧道配置从“云端 Dashboard 托管”迁移为“本地 CLI/Config 文件托管”，虽然初期配置稍繁琐，但保证了开发环境配置（如 Ingress 规则）的代码化和版本可控性。

---

# 2026-01-18 开发日志 (Part 9)

## 任务：修复导航重定向死循环

### 1. 方案实施
- **营销页修复**：修正了 `frontend/app/page.tsx` 中的 `onAuthStateChange` 监听器。此前它会忽略 URL 中的 `noredirect=1` 参数，导致已登录用户在访问首页时被强行弹回仪表盘。
- **Logo 链接统一**：
    - 更新了仪表盘侧边栏 Logo 链接。
    - 在报告页（Result Page）为 Logo 增加了链接包裹。
    - 统一使用 `/?noredirect=1` 作为目标地址，确保用户点击图标能稳定停留在营销页。

### 2. 回顾
- **逻辑严密性**：单页应用（SPA）中的状态监听器（如 Supabase Auth Change）比单纯的 `useEffect` 初始化检查更具强制性。在实现“防止重定向”功能时，必须确保所有相关的路由跳转逻辑都遵循同样的白名单或参数规则。

---

# 2026-01-18 开发日志 (Part 8)

## 任务：修复 dev.sh 日志着色失效问题

### 1. 方案实施
- **颜色定义重构**：将 `dev.sh` 中的颜色变量从普通字符串改为 `$(printf '\033[...]')`。这确保了变量中存储的是真实的不可见转义字符，而非字面值。
- **输出命令迁移**：将脚本中所有的 `echo -e` 替换为 `printf`。因为 macOS 默认的 `echo` 对 `-e` 参数的支持在不同 Shell 下存在差异，而 `printf` 在处理 `%b`（带转义的字符串）时更具通用性。
- **验证**：通过在 macOS 终端模拟环境测试，确认 `[BACKEND]` 和 `[FRONTEND]` 前缀已能正确着色。

### 2. 回顾
- **兼容性教训**：跨平台的 Shell 脚本开发中，应优先使用 `printf` 替代 `echo` 来处理颜色和特殊字符，以规避 BSD (macOS) 与 GNU (Linux) 工具链的细微差别。

---

# 2026-01-18 开发日志 (Part 7)

## 任务：补充开发指南端口检查特性

### 1. 方案实施
- **文档更新**：在 `docs/development_guide.md` 的 `dev.sh` 章节中新增了“自动化冲突处理”说明。
- **内容细化**：明确告知开发者脚本会自动尝试释放 8000 和 3000 端口，提升了“开发环境自愈”功能的透明度。

### 2. 回顾
- **文档同步性**：确保了新特性（端口检查）与指导文档的实时同步，避免了功能虽好但无人知晓的情况。

---

# 2026-01-18 开发日志 (Part 6)

## 任务：增强 dev.sh 端口检查能力

### 1. 方案实施
- **脚本逻辑优化**：在 `dev.sh` 中集成了 `check_and_kill_port` 函数。
- **自动化清理**：脚本启动前会扫描 8000 (Backend) 和 3000 (Frontend) 端口。如果发现被旧进程占用，将自动执行 `kill -9` 强行释放端口。
- **健壮性修复**：修复了在添加端口检查时意外移除 `cleanup()` 函数的问题，确保 `Ctrl+C` 依然能正确终止当前会话启动的所有子进程。

### 2. 回顾
- **用户体验**：解决了开发者最常见的“Port already in use”报错，实现了“一键点击，绝对启动”的顺滑体验。
- **安全性**：虽然使用 `kill -9` 比较激进，但在本地开发环境下，这是保证端口及时释放、避免僵尸进程的最佳折中方案。

---

# 2026-01-18 开发日志 (Part 5)

## 任务：编写开发启动与日志监控指南

### 1. 方案实施
- **文档编写**：创建了 `docs/development_guide.md`，涵盖了：
    - 使用 `./dev.sh` 实现的一键着色启动。
    - 后端与前端的手动分步启动详细步骤。
    - 实时日志监控、持久化日志记录以及常见 HTTP/CORS 错误的排查思路。
- **入口集成**：在 `README.md` 的“指南与规划”章节添加了直达链接。

### 2. 回顾
- **规范性**：将此前散落在各处的启动命令统一归档，降低了新环境部署的认知门槛。
- **可操作性**：文档特别强调了日志前缀的识别，有助于开发者在复合屏幕下更直观地定位异步任务的瓶颈。

---

# 2026-01-18 开发日志 (Part 4)

## 任务：修复报告页 404 错误与接口验证

### 1. 需求背景
- **问题描述**：前端请求 `/view` 和 `/comments` 接口返回 404 错误，导致页面无法正确显示阅读数和评论。
- **关键 Error**：`POST https://api.read-tube.com/result/UBE4vkQrSb8/view 404 (Not Found)`

### 2. 方案实施
- **后端**：检查并在 `main.py` 中发现了一处干扰路由注册的冗余 `return` 语句，已将其移除。
- **验证**：在虚拟环境下通过 `app.routes` 列表验证了所有新接口（`/view`, `/like`, `/comments`）已正确注册。

### 3. 回顾
- **根因分析**：代码合并过程中残留的旧逻辑中断了 FastAPI 的路由定义流。
- **改进**：建议在修改 `main.py` 后执行简单的路由发现脚本以确保所有端点生效。

---

# 2026-01-18 开发日志 (Part 3)

## 任务：实现一键开发启动脚本

### 1. 方案实施
- **脚本编写**：创建 `dev.sh`，利用后台进程控制和 `sed` 工具实现日志着色及前缀注入。
- **功能优化**：增加了对 `backend/venv` 的自动识别，简化了开发者在不同环境下的切换。
- **集成**：更新 `README.md`，将此脚本推荐为首选开发启动方式。

### 2. 回顾
- **便捷性**：通过一个命令即可管理两个复杂服务的生命周期，提升了开发效率。
- **可维护性**：脚本逻辑简单透明，易于后续根据需求添加更多启动检查。

---

## 任务：实现项目历史展示功能

### 1. 需求背景
- **问题描述**：需要将项目内部的审计记录（PROJECT_HISTORY.md）暴露在前端页面上，增加透明度和可追溯性。

### 2. 方案实施
- **后端**：添加了专用路由，通过 Python 流式读取 Markdown 并解析为结构化 JSON。
- **前端**：创建了 `/project-history` 路由，采用深色模式友好的时间轴布局。
- **集成**：在网站页脚添加了入口链接。

### 3. 回顾
- **性能**：由于 Markdown 文件体积较小，接口响应极快，无需额外数据库存储，降低了维护成本。
- **UI/UX**：页面采用了精美的卡片设计和 Lucide 图标，具备良好的阅读体验。

---
- **修复结果**：通过在 `downloader.py` 中使用延迟导入，LSP 的栈溢出问题得到根本解决，文件编辑体验恢复流畅。
- **存储优化**：实现了“即时自动化删除”（提取音频后删除原视频）和“定期清理”（3天周期清理大文件）的双重保障。
- **首次执行**：`cleanup_downloads.py` 成功释放 469.30 MB 空间。

### 4. 经验
- **LSP 调优**：对于依赖复杂外部库的项目，保持顶层导入简洁是维持 IDE 性能的关键。
- **资源最小化**：在多媒体处理流程中，尽早转换并裁剪原始大文件是成本控制的最佳实践。

---
# 2026-01-18 开发日志

## 任务：诊断并解决 LSP (Pyrefly) 崩溃问题

### 1. 需求背景
- **问题描述**：LSP 服务器 `Pyrefly` 在打开 `backend/downloader.py` 时反复发生 `stack overflow` 崩溃。
- **关键 Error**：`thread '<unknown>' (5606705) has overflowed its stack`

### 2. 方案计划
- **初步诊断**：怀疑是 LSP 在解析 `yt-dlp` 复杂类型树时发生了无限递归。
- **实施方案**：
    1. 将 `backend/downloader.py` 中的 `import yt_dlp` 改为函数内延迟导入。
    2. 验证后端服务功能不受影响。
    3. 观察 LSP 是否恢复稳定。

---
