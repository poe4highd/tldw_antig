# 2026-02-27 开发日志

### [前置] 确认视频 OOwS_HHOWfs 最终处理完成并优化 GPU 推理
- **需求**：确认崩溃恢复后的测试视频 `OOwS_HHOWfs` 能否顺利完成全流程。并根据用户要求“确保后端转录是使用GPU吧”，排查并修正转录脚本底层的算力调用。
- **计划**：
  1. 重新执行后台进程清理，前台监控启动 `process_task.py OOwS_HHOWfs`。
  2. 检查 `transcriber.py` 中的 `faster-whisper` 的设备及精度配置。
  3. 修复 CPU fallback 逻辑，强制通过 CUDA（`float16`）挂载转录模型替代原有的内建探测逻辑。

### [回顾] 实际改动
1. **GPU加速修复**: 分析 `transcriber.py` 发现非 Apple Silicon 的 Linux 环境下，原探测语法缺少 `torch` 直接引发 `faster-whisper` 降级为了 `cpu: int8`。将其修改为更安全的硬装配 `device="cuda", compute_type="float16"` 再进入 Fallback，显著加快了推理时间（~8分钟视频通过 GPU 成功处理完毕）。
2. **长尾处理验证**: 实测确认进程彻底跑到 100% 且生成了完整的 `/results/OOwS_HHOWfs.json`，包含了精准的时间戳与文字映射，任务状态完美。
3. **消除卡死因素**: 过程中通过观察及时剥离消灭了偶发的 `yt-dlp` 网络无响应问题，验证了状态同步脚本能够正常终止异常流。

### [经验] 关键机制与坑点
- **CUDA 依赖加载**: `faster-whisper` 底层其实可以直接设置 `device="cuda"` 唤起 CTranslate2 执行运算，如果强行为了做状态探测而去 `import torch`，会导致部分轻量化隔离环境报出 `No module named 'torch'` 从而引发不可预期的 Worker 崩溃降级。直接抛出执行再 Try-Catch 兜底是更健壮的做法。
### [前置] 修复视频处理崩溃且状态不同步的问题 (OOwS_HHOWfs)
- **需求**：处理视频 OOwS_HHOWfs 时直接进入 local status=failed 且无错误日志，云端卡在 processing。需按视频处理步骤分段逐步排查并修复，同时统一异常捕获以确保失败状态可正确回传云端。
- **计划**：
  1. 排查并模拟 `process_task.py` 获取视频信息及下载步骤，定位崩溃点。
  2. 修复具体的触发崩溃的基础 bug。
  3. 完善 `process_task.py` 等外层管理脚本的全局异常捕获机制，确保发生崩溃时向数据库正确写回 failed。

### [回顾] 实际改动
1. **状态脱节修复**: 修复了 `scheduler.py` 捕获到子进程异常退出（如网络挂死、环境杀进程或代码执行错误）时，只更新本地状态不更新 Supabase 导致云端永恒卡死的核心 bug。
2. **早期退出防护**: 在 `process_task.py` 前期空参数退出流中补充了云端同步判定。
3. **数据纠正**: 手动将云端因意外而残留卡死的 OOwS_HHOWfs 任务修正回 failed。

### [经验] 关键机制与坑点
- **异构状态的强一致性陷阱**: 在云端-本机的两套状态流（DB 与 JSON 文件）中，如果某个中间监督程序（如 `scheduler.py`）单方面宣布了本地失败而未同步云端，系统将无限期僵死。处理异常分支时，“凡写本地状态放弃，必发云端通告”需严格落地。

### [前置] 视频报告页面空间与信息密度优化
- **需求**：Desktop端视频报告页面的上下留白占用过多，视觉上信息密度低，需调整各版块 padding 和 gap 进行精简。
- **计划**：
  1. Title区域：去除强制高度 `min-h-[140px]`，收紧字号与行高。
  2. 页面容器：缩小 Nav `py-4` 到 `py-2.5`，Main的 `py-6 gap-6` 到 `py-3 gap-3`。
  3. 字幕与摘要：缩减 AI Summary 和 Subtitle 容器自身的 padding 及各项内部的 space-y，同时优化字幕段落行高为 `leading-[1.65]`。
  4. 底部讨论区：降低最小高度和下边距占位。

### [回顾] 实际改动
- **响应式排版压缩**：移除了中间Title区的 `min-h-[140px]` 定高，调整了 Nav 和 Main 容器的 padding 和 gap，回收了大量的垂直高度。
- **正文高度释放**：将字幕与 AI Summary 卡片的 padding 下降到 `p-4/p-5` 级别，精简字幕行高 `leading-[1.65]`，一屏可视字幕行数显著增加。
- **重叠漏洞修复**：在替换时由于多处相近结构重叠产生了分块替换冲突，通过手动定位并二次覆盖成功修复了摘要卡片的精简任务。

### [经验] 关键机制与坑点
- **动态占位优先于静态硬编码**：大屏幕响应式布局时，过大的 `p-8` 或硬核的 `h-[600px]` 是吞噬信息密度的源头。采用自适应高度加轻量 padding（16-24px）是现代化高密度信息页面的更佳实践。
- **基于行匹配工具的特性差异**：行替换处理多处近似内容的布局调整时易产生边界重叠冲突，单文件的多处重构最好通过清晰界定上下文字符串进行。

### [需求] 修复前端进度条假死为100%与进度不更新问题
- **背景**: 用户反馈提交任务后前端立刻显示100%，与本地真实进度（如60%）完全不符。且任务历史长时间显示 5%。
- **Error Stack**: 无显式报错，但前台状态展示错误，且修改代码后引入过 `IndentationError` 导致服务未能重启。
- **影响文件**: `backend/main.py`

### [计划]
1. 分析前端轮询逻辑和对应的后端 `/result/{task_id}` 以及 `/history` API。
2. 将后端死板返回 `progress: 100` 的逻辑修改为读取真实本地 `_status.json` 的进度。
3. 捕获任务提交至完成全周期的真实验证测试。

### [回顾] 实际改动
1. **API逻辑修正**: 移除了 `main.py` 中只要存入 Supabase 无论任务处于 `queued`, `processing` 则统统返回 100% 的荒谬逻辑。改为：仅当 `status == "completed"` 且含有分段数据时才视作最终完成；其余状态下沉到底层 `_status.json` 抽取实时进度汇报。
2. **语法错误修复**: 解决替换代码时发生的 `IndentationError`，令 uvicorn 服务恢复正常并重新加载。
3. **全链路回归测试**: 推送更新前使用超级长视频 `gwv-SJZGcJE`（约一个半小时、98MB），配合云端转录大模型并指定测试用户`poe`。经过实测监控近十几分钟证实：转录、格式化、更新数据库各项关键步骤完全顺利，前端状态请求 API `/result` 行为健康准确。

### [经验] 关键机制与坑点
- **虚假进度带来的阻塞错觉**: 如果任务进度被后端接口伪造屏蔽，前端一旦挂载就会被进度死锁误导。对特别巨大的视频（耗时超过10-20分钟），让用户清晰看到准确到数字（本案中的真实 60%）是极有意义且可以降低客诉率的。
- **状态兜底查询路线**: 应当坚定“Supabase 为展示与最终完成负责，本地文件（_status.json）为过程中动态追踪负责”的分层策略，保障双端数据融合。
