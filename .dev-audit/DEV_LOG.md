# 2026-02-27 开发日志

### [需求] 修复前端进度条假死为100%与进度不更新问题
- **背景**: 用户反馈提交任务后前端立刻显示100%，与本地真实进度（如60%）完全不符。且任务历史长时间显示 5%。
- **Error Stack**: 无显式报错，但前台状态展示错误，且修改代码后引入过 `IndentationError` 导致服务未能重启。
- **影响文件**: `backend/main.py`

### [计划]
1. 分析前端轮询逻辑和对应的后端 `/result/{task_id}` 以及 `/history` API。
2. 将后端死板返回 `progress: 100` 的逻辑修改为读取真实本地 `_status.json` 的进度。
3. 捕获任务提交至完成全周期的真实验证测试。

### [回顾] 实际改动
1. **API逻辑修正**: 移除了 `main.py` 中只要存入 Supabase 无论任务处于 `queued`, `processing` 则统统返回 100% 的荒谬逻辑。改为：仅当 `status == "completed"` 且含有分段数据时才视作最终完成；其余状态下沉到底层 `_status.json` 抽取实时进度汇报。
2. **语法错误修复**: 解决替换代码时发生的 `IndentationError`，令 uvicorn 服务恢复正常并重新加载。
3. **全链路回归测试**: 推送更新前使用超级长视频 `gwv-SJZGcJE`（约一个半小时、98MB），配合云端转录大模型并指定测试用户`poe`。经过实测监控近十几分钟证实：转录、格式化、更新数据库各项关键步骤完全顺利，前端状态请求 API `/result` 行为健康准确。

### [经验] 关键机制与坑点
- **虚假进度带来的阻塞错觉**: 如果任务进度被后端接口伪造屏蔽，前端一旦挂载就会被进度死锁误导。对特别巨大的视频（耗时超过10-20分钟），让用户清晰看到准确到数字（本案中的真实 60%）是极有意义且可以降低客诉率的。
- **状态兜底查询路线**: 应当坚定“Supabase 为展示与最终完成负责，本地文件（_status.json）为过程中动态追踪负责”的分层策略，保障双端数据融合。
